#include <stdio.h>
#include <stdlib.h>
#include <sys/time.h>
#include <math.h>

#define SAMPLE_TEST_LEN 2048
#define SCALER 4096
#define LUT_SIZE 1024

short lut_sigmoid[LUT_SIZE] = {
    2048,2056,2064,2072,2080,2088,2096,2104,
    2112,2120,2128,2136,2144,2152,2160,2168,
    2176,2184,2192,2200,2208,2216,2224,2232,
    2239,2247,2255,2263,2271,2279,2287,2295,
    2303,2311,2318,2326,2334,2342,2350,2358,
    2365,2373,2381,2389,2397,2404,2412,2420,
    2428,2435,2443,2451,2458,2466,2474,2481,
    2489,2497,2504,2512,2519,2527,2535,2542,
    2550,2557,2565,2572,2580,2587,2594,2602,
    2609,2617,2624,2631,2639,2646,2653,2661,
    2668,2675,2682,2690,2697,2704,2711,2718,
    2726,2733,2740,2747,2754,2761,2768,2775,
    2782,2789,2796,2803,2810,2817,2823,2830,
    2837,2844,2851,2857,2864,2871,2878,2884,
    2891,2898,2904,2911,2917,2924,2930,2937,
    2943,2950,2956,2963,2969,2975,2982,2988,
    2994,3001,3007,3013,3019,3026,3032,3038,
    3044,3050,3056,3062,3068,3074,3080,3086,
    3092,3098,3104,3110,3116,3121,3127,3133,
    3139,3144,3150,3156,3161,3167,3173,3178,
    3184,3189,3195,3200,3206,3211,3217,3222,
    3227,3233,3238,3243,3249,3254,3259,3264,
    3269,3275,3280,3285,3290,3295,3300,3305,
    3310,3315,3320,3325,3330,3334,3339,3344,
    3349,3354,3358,3363,3368,3372,3377,3382,
    3386,3391,3395,3400,3404,3409,3413,3418,
    3422,3427,3431,3435,3440,3444,3448,3452,
    3457,3461,3465,3469,3473,3477,3481,3486,
    3490,3494,3498,3502,3506,3510,3513,3517,
    3521,3525,3529,3533,3536,3540,3544,3548,
    3551,3555,3559,3562,3566,3570,3573,3577,
    3580,3584,3587,3591,3594,3598,3601,3604,
    3608,3611,3614,3618,3621,3624,3628,3631,
    3634,3637,3640,3644,3647,3650,3653,3656,
    3659,3662,3665,3668,3671,3674,3677,3680,
    3683,3686,3689,3691,3694,3697,3700,3703,
    3705,3708,3711,3714,3716,3719,3722,3724,
    3727,3730,3732,3735,3737,3740,3742,3745,
    3747,3750,3752,3755,3757,3760,3762,3764,
    3767,3769,3772,3774,3776,3778,3781,3783,
    3785,3788,3790,3792,3794,3796,3798,3801,
    3803,3805,3807,3809,3811,3813,3815,3817,
    3819,3821,3823,3825,3827,3829,3831,3833,
    3835,3837,3839,3841,3843,3844,3846,3848,
    3850,3852,3853,3855,3857,3859,3861,3862,
    3864,3866,3867,3869,3871,3872,3874,3876,
    3877,3879,3880,3882,3884,3885,3887,3888,
    3890,3891,3893,3894,3896,3897,3899,3900,
    3902,3903,3905,3906,3907,3909,3910,3912,
    3913,3914,3916,3917,3918,3920,3921,3922,
    3924,3925,3926,3927,3929,3930,3931,3932,
    3934,3935,3936,3937,3938,3940,3941,3942,
    3943,3944,3945,3947,3948,3949,3950,3951,
    3952,3953,3954,3955,3956,3957,3958,3959,
    3960,3961,3963,3964,3965,3966,3966,3967,
    3968,3969,3970,3971,3972,3973,3974,3975,
    3976,3977,3978,3979,3980,3980,3981,3982,
    3983,3984,3985,3986,3986,3987,3988,3989,
    3990,3990,3991,3992,3993,3994,3994,3995,
    3996,3997,3997,3998,3999,4000,4000,4001,
    4002,4003,4003,4004,4005,4005,4006,4007,
    4007,4008,4009,4009,4010,4011,4011,4012,
    4013,4013,4014,4015,4015,4016,4016,4017,
    4018,4018,4019,4019,4020,4021,4021,4022,
    4022,4023,4023,4024,4025,4025,4026,4026,
    4027,4027,4028,4028,4029,4029,4030,4030,
    4031,4031,4032,4032,4033,4033,4034,4034,
    4035,4035,4036,4036,4037,4037,4038,4038,
    4038,4039,4039,4040,4040,4041,4041,4041,
    4042,4042,4043,4043,4043,4044,4044,4045,
    4045,4045,4046,4046,4047,4047,4047,4048,
    4048,4048,4049,4049,4050,4050,4050,4051,
    4051,4051,4052,4052,4052,4053,4053,4053,
    4054,4054,4054,4055,4055,4055,4056,4056,
    4056,4057,4057,4057,4057,4058,4058,4058,
    4059,4059,4059,4059,4060,4060,4060,4061,
    4061,4061,4061,4062,4062,4062,4062,4063,
    4063,4063,4063,4064,4064,4064,4064,4065,
    4065,4065,4065,4066,4066,4066,4066,4067,
    4067,4067,4067,4068,4068,4068,4068,4068,
    4069,4069,4069,4069,4069,4070,4070,4070,
    4070,4070,4071,4071,4071,4071,4071,4072,
    4072,4072,4072,4072,4073,4073,4073,4073,
    4073,4073,4074,4074,4074,4074,4074,4074,
    4075,4075,4075,4075,4075,4075,4076,4076,
    4076,4076,4076,4076,4077,4077,4077,4077,
    4077,4077,4077,4078,4078,4078,4078,4078,
    4078,4078,4079,4079,4079,4079,4079,4079,
    4079,4079,4080,4080,4080,4080,4080,4080,
    4080,4080,4081,4081,4081,4081,4081,4081,
    4081,4081,4082,4082,4082,4082,4082,4082,
    4082,4082,4082,4082,4083,4083,4083,4083,
    4083,4083,4083,4083,4083,4084,4084,4084,
    4084,4084,4084,4084,4084,4084,4084,4084,
    4085,4085,4085,4085,4085,4085,4085,4085,
    4085,4085,4085,4085,4086,4086,4086,4086,
    4086,4086,4086,4086,4086,4086,4086,4086,
    4086,4087,4087,4087,4087,4087,4087,4087,
    4087,4087,4087,4087,4087,4087,4087,4088,
    4088,4088,4088,4088,4088,4088,4088,4088,
    4088,4088,4088,4088,4088,4088,4088,4089,
    4089,4089,4089,4089,4089,4089,4089,4089,
    4089,4089,4089,4089,4089,4089,4089,4089,
    4089,4090,4090,4090,4090,4090,4090,4090,
    4090,4090,4090,4090,4090,4090,4090,4090,
    4090,4090,4090,4090,4090,4090,4090,4091,
    4091,4091,4091,4091,4091,4091,4091,4091,
    4091,4091,4091,4091,4091,4091,4091,4091,
    4091,4091,4091,4091,4091,4091,4091,4091,
    4091,4092,4092,4092,4092,4092,4092,4092,
    4092,4092,4092,4092,4092,4092,4092,4092,
    4092,4092,4092,4092,4092,4092,4092,4092,
    4092,4092,4092,4092,4092,4092,4092,4092,
    4092,4093,4093,4093,4093,4093,4093,4093,
    4093,4093,4093,4093,4093,4093,4093,4093,
    4093,4093,4093,4093,4093,4093,4093,4093,
    4093,4093,4093,4093,4093,4093,4093,4093,
    4093,4093,4093,4093,4093,4093,4093,4093,
    4093,4093,4093,4093,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4095,4095};

short lut_tanh[LUT_SIZE] = {
    0,32,64,96,128,160,192,224,
    256,288,319,351,383,415,446,478,
    509,541,572,604,635,666,697,728,
    759,790,821,851,882,912,943,973,
    1003,1033,1063,1093,1123,1152,1181,1211,
    1240,1269,1298,1326,1355,1383,1412,1440,
    1468,1496,1523,1551,1578,1605,1632,1659,
    1686,1712,1739,1765,1791,1817,1842,1868,
    1893,1918,1943,1968,1992,2016,2041,2064,
    2088,2112,2135,2158,2181,2204,2227,2249,
    2272,2294,2316,2337,2359,2380,2401,2422,
    2443,2463,2484,2504,2524,2543,2563,2582,
    2602,2621,2639,2658,2676,2695,2713,2731,
    2748,2766,2783,2800,2817,2834,2851,2867,
    2883,2899,2915,2931,2946,2962,2977,2992,
    3007,3021,3036,3050,3064,3078,3092,3106,
    3119,3133,3146,3159,3172,3185,3197,3210,
    3222,3234,3246,3258,3270,3281,3293,3304,
    3315,3326,3337,3347,3358,3368,3379,3389,
    3399,3409,3419,3428,3438,3447,3456,3466,
    3475,3483,3492,3501,3510,3518,3526,3535,
    3543,3551,3559,3566,3574,3582,3589,3596,
    3604,3611,3618,3625,3632,3639,3645,3652,
    3659,3665,3671,3678,3684,3690,3696,3702,
    3707,3713,3719,3724,3730,3735,3741,3746,
    3751,3756,3761,3766,3771,3776,3781,3786,
    3790,3795,3799,3804,3808,3812,3817,3821,
    3825,3829,3833,3837,3841,3845,3848,3852,
    3856,3859,3863,3867,3870,3873,3877,3880,
    3883,3887,3890,3893,3896,3899,3902,3905,
    3908,3911,3913,3916,3919,3922,3924,3927,
    3929,3932,3934,3937,3939,3942,3944,3946,
    3949,3951,3953,3955,3957,3960,3962,3964,
    3966,3968,3970,3972,3973,3975,3977,3979,
    3981,3983,3984,3986,3988,3989,3991,3993,
    3994,3996,3997,3999,4000,4002,4003,4005,
    4006,4007,4009,4010,4011,4013,4014,4015,
    4016,4018,4019,4020,4021,4022,4024,4025,
    4026,4027,4028,4029,4030,4031,4032,4033,
    4034,4035,4036,4037,4038,4039,4039,4040,
    4041,4042,4043,4044,4044,4045,4046,4047,
    4048,4048,4049,4050,4050,4051,4052,4053,
    4053,4054,4055,4055,4056,4056,4057,4058,
    4058,4059,4059,4060,4061,4061,4062,4062,
    4063,4063,4064,4064,4065,4065,4066,4066,
    4067,4067,4067,4068,4068,4069,4069,4070,
    4070,4070,4071,4071,4072,4072,4072,4073,
    4073,4073,4074,4074,4074,4075,4075,4075,
    4076,4076,4076,4077,4077,4077,4078,4078,
    4078,4078,4079,4079,4079,4079,4080,4080,
    4080,4080,4081,4081,4081,4081,4082,4082,
    4082,4082,4082,4083,4083,4083,4083,4084,
    4084,4084,4084,4084,4084,4085,4085,4085,
    4085,4085,4085,4086,4086,4086,4086,4086,
    4086,4087,4087,4087,4087,4087,4087,4087,
    4088,4088,4088,4088,4088,4088,4088,4088,
    4089,4089,4089,4089,4089,4089,4089,4089,
    4089,4090,4090,4090,4090,4090,4090,4090,
    4090,4090,4090,4090,4091,4091,4091,4091,
    4091,4091,4091,4091,4091,4091,4091,4091,
    4091,4092,4092,4092,4092,4092,4092,4092,
    4092,4092,4092,4092,4092,4092,4092,4092,
    4092,4093,4093,4093,4093,4093,4093,4093,
    4093,4093,4093,4093,4093,4093,4093,4093,
    4093,4093,4093,4093,4093,4093,4093,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4094,
    4094,4094,4094,4094,4094,4094,4094,4095,
    4095,4095,4095,4095,4095,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4095,4095,
    4095,4095,4095,4095,4095,4095,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096,
    4096,4096,4096,4096,4096,4096,4096,4096};

void lstm_n5_o1(
    int input[SAMPLE_TEST_LEN],
    short output[SAMPLE_TEST_LEN])
{
    int i, j, t;

    float inW[4][5] = {
        -0.00902497, 0.0130347, -0.305604, 0.0103134, -0.00143173,
        -0.00892103, -0.00877193, -0.0158959, -0.00261989, 0.00238156,
        -1.17159, -1.05888, -0.0252563, 1.32337, 0.896013,
        0.112793, 0.107382, 0.459561, 0.112837, -0.0858938};

    float intW[4][5][5] = {
        {{0.01465, 0.017885, 0.00462623, -0.00366126, 0.00414583}, 
        {0.00709106, 0.00612325, 0.00509018, 0.00629193, -0.00820282},
        {0.0594903, 0.0594652, 0.0879106, -0.202968, 0.146663},
        {0.0173266, -0.00258213, -0.00156304, -0.0161799, 0.0206139}, 
        {0.00378391, 0.0190192, 0.0140174, 0.0183843, -0.00042357}}, 
        {{-0.007224, -2.52633e-05, -0.00375626, 0.0171819, -0.0146835}, 
        {0.0095475, 0.0111485, 0.00723207, -0.00279432, -0.00130744}, 
        {-0.00358937, -0.0211212, -0.0445563, -0.0203464, 0.0123881},
        {-0.00648264, -0.00841806, 0.00112013, 0.00435087, -0.0138258}, 
        {0.00533612, -0.00909088, 0.00789575, 0.00117046, 0.00834566}}, 
        {{0.74772, 0.635634, 0.730541, -1.11435, 0.814002}, 
        {0.623608, 0.53032, 0.652992, -1.01461, 0.768323},
        {0.120079, 0.113368, 0.0824013, -0.000308211, -0.0182162},
        {-1.28265, -1.18123, -0.480213, 0.984297, -0.576107}, 
        {-1.00799, -0.944089, -0.355751, 0.536079, -0.27723}},
        {{0.0134795, 0.0447042, 0.015088, 0.0920375, -0.0777375}, 
        {0.0384587, 0.0330071, 0.0205698, 0.0858556, -0.0671409}, 
        {-0.63912, -0.570696, -0.0891825, 0.706698, -0.5}, 
        {0.0172945, 0.0240723, 0.00149645, 0.0341813, -0.0418003}, 
        {-0.0122831, -0.0280598, -0.00341253, -0.0265756, 0.0246845}}
    }; 

    float intB[4][5] = {
        0.016, 0.0139732, -0.183891, 0.0139634, 0.00864378,
        5.00094, 5.00059, 4.97023, 5.0002, 5.00032,
        0.0676543, -0.0445895, 0.248995, -0.978814, -1.0258,
        0.204404, 0.190113, -0.156202, 0.219446, -0.179526}; 

    float outW[5] = {-0.4272, -0.33769, 0.167592, 0.50495, -0.502329};

    float outB = -0.0394433;

    float h_state[5] = {0};
    float c_state[5] = {0};
    float i_state[5] = {0};
    float f_state[5] = {0};
    float o_state[5] = {0};
    float g_state[5] = {0};

    short inWF[4][5] = {0};
    short intWF[4][5][5] = {0};
    short intBF[4][5] = {0};
    short outWF[5] = {0};
    short outBF = 0;

    for (i = 0; i < 4; ++i) {
        for (j = 0; j < 5; ++j) {
            inWF[i][j] = (short) (inW[i][j] * SCALER);
            //printf("%d\n", inWF[i][j]);
        }
    }

    for (i = 0; i < 4; ++i) {
        for (j = 0; j < 5; ++j) {
            for (t = 0; t < 5; ++t) {
                intWF[i][j][t] = (short) (intW[i][j][t] * SCALER);
                //printf("%d\n", intWF[i][j][t]);
            }
        }
    }

    for (i = 0; i < 4; ++i) {
        for (j = 0; j < 5; ++j) {
            intBF[i][j] = (short) (intB[i][j] * SCALER);
            //printf("%d\n", intBF[i][j]);
        }
    }

    for (i = 0; i < 5; ++i) {
        outWF[i] = (short) (outW[i] * SCALER);
        //printf("%d\n", outWF[i]);
    }

    outBF = (short) (outB * SCALER);
    //printf("%d\n", outBF);

    short h_stateF[5] = {0};
    short c_stateF[5] = {0};
    short i_stateF[5] = {0};
    short f_stateF[5] = {0};
    short o_stateF[5] = {0};
    short g_stateF[5] = {0};

    short sampleinput_16b;

    for (t = 0; t < SAMPLE_TEST_LEN; ++t) {

        sampleinput_16b = (short) (input[t] + 120000) * 256 / 1875;

        for (j = 0; j < 5; ++j) {
            i_stateF[j] = (inWF[0][j] * sampleinput_16b) >> 15;
            for (i = 0; i < 5; ++i)
                i_stateF[j] += ((h_stateF[i] * intWF[0][j][i]) >> 12);
            i_stateF[j] += intBF[0][j];
            i_stateF[j] = i_stateF[j] >> 5;
            if (i_stateF[j] >= LUT_SIZE)
                i_stateF[j] = 4095;
            else if (i_stateF[j] >= 0)
                i_stateF[j] = lut_sigmoid[i_stateF[j]];
            else if (i_stateF[j] > -LUT_SIZE)
                i_stateF[j] = 4096 - lut_sigmoid[-i_stateF[j]];
            else
                i_stateF[j] = 1;
        }

        for (j = 0; j < 5; ++j) {
            f_stateF[j] = (inWF[1][j] * sampleinput_16b) >> 15;
            for (i = 0; i < 5; ++i)
                f_stateF[j] += ((h_stateF[i] * intWF[1][j][i]) >> 12);
            f_stateF[j] += intBF[1][j];
            f_stateF[j] = f_stateF[j] >> 5;
            if (f_stateF[j] >= LUT_SIZE)
                f_stateF[j] = 4095;
            else if (f_stateF[j] >= 0)
                f_stateF[j] = lut_sigmoid[f_stateF[j]];
            else if (f_stateF[j] > -LUT_SIZE)
                f_stateF[j] = 4096 - lut_sigmoid[-f_stateF[j]];
            else
                f_stateF[j] = 1;
        }

        for (j = 0; j < 5; ++j) {
            o_stateF[j] = (inWF[2][j] * sampleinput_16b) >> 15;
            for (i = 0; i < 5; ++i)
                o_stateF[j] += ((h_stateF[i] * intWF[2][j][i]) >> 12);
            o_stateF[j] += intBF[2][j];
            o_stateF[j] = o_stateF[j] >> 5;
            if (o_stateF[j] >= LUT_SIZE)
                o_stateF[j] = 4095;
            else if (o_stateF[j] >= 0)
                o_stateF[j] = lut_sigmoid[o_stateF[j]];
            else if (o_stateF[j] > -LUT_SIZE)
                o_stateF[j] = 4096 - lut_sigmoid[-o_stateF[j]];
            else
                o_stateF[j] = 1;
        }

        for (j = 0; j < 5; ++j) {
            g_stateF[j] = (inWF[3][j] * sampleinput_16b) >> 15;
            for (i = 0; i < 5; ++i)
                g_stateF[j] += ((h_stateF[i] * intWF[3][j][i]) >> 12);
            g_stateF[j] += intBF[3][j];
            g_stateF[j] = g_stateF[j] >> 5;
            if (g_stateF[j] >= LUT_SIZE)
                g_stateF[j] = 4096;
            else if (g_stateF[j] >= 0)
                g_stateF[j] = lut_tanh[g_stateF[j]];
            else if (g_stateF[j] > -LUT_SIZE)
                g_stateF[j] = -lut_tanh[-g_stateF[j]];
            else
                g_stateF[j] = -4096;
        }
        
        for (j = 0; j < 5; ++j) {
            c_stateF[j] = (((c_stateF[j] * f_stateF[j]) >> 8) + ((g_stateF[j] * i_stateF[j]) >> 12)) >> 4;
            h_stateF[j] = c_stateF[j] >> 1;
            if (h_stateF[j] >= LUT_SIZE)
                h_stateF[j] = 4096;
            else if (h_stateF[j] >= 0)
                h_stateF[j] = lut_tanh[h_stateF[j]];
            else if (h_stateF[j] > -LUT_SIZE)
                h_stateF[j] = -lut_tanh[-h_stateF[j]];
            else
                h_stateF[j] = -4096;
            h_stateF[j] = (h_stateF[j] * o_stateF[j]) >> 12;
        }

        output[t] = outBF;
        for (j = 0; j < 5; ++j)
            output[t] += ((h_stateF[j] * outWF[j]) >> 12);
    }

    return;
}

void lstm_n5_o2(
    int input[SAMPLE_TEST_LEN],
    short output[SAMPLE_TEST_LEN])
{
    int i, j, t;

    float inW[4][5] = {
        -0.133907, 0.0967799, -0.0249856, -0.0482016, 0.000138663,
        -0.0025821, -0.0107074, -0.0135626, -0.0265616, -0.00990482,
        0.0279149, 0.29944, 0.00367669, -0.0406378, -0.122106,
        0.305937, -1.54966, 0.108542, -0.086096, -0.278674};

    float intW[4][5][5] = {
        {{0.0465599, -0.0784586, 0.0703757, -0.0961503, 0.103885}, 
        {0.137839, 0.0785531, 0.172321, 0.00198996, 0.115174}, 
        {0.0896546, -0.00207286, 0.0280649, 0.0300854, 0.0549556},
        {0.0952124, 0.011873, 0.0253059, -0.00619738, 0.10025},
        {-0.0796523, -0.0310471, 0.0336561, -0.0999846, -0.00944991}}, 
        {{-0.00558139, -0.0249531, -0.0196812, -0.0283953, -0.00538974}, 
        {0.0124158, 0.00739093, 0.00918819, -0.00951965, 0.00634635}, 
        {-0.008908, 0.0113348, -0.00387874, 0.00339979, -0.000628876}, 
        {-0.00832763, 0.0040069, 0.00346749, -0.0256792, 0.00539768},
        {0.00337389, -0.0148225, -0.0283464, 0.00277652, 0.000571859}}, 
        {{-0.00736941, 0.0578041, 0.141176, 0.00565979, -0.079775},
        {-0.140356, 0.0521767, 0.0813636, -0.0342324, -0.0847605},
        {0.0534741, 0.0335436, 0.0464466, 0.0670157, 0.0266309},
        {0.0142565, -0.0397183, -0.0116136, -0.0507669, 0.0575363},
        {-0.0518841, 0.0358612, 0.0333015, -0.119254, 0.0368938}}, 
        {{-0.40111, 1.17447, 0.172804, 0.197255, 0.0786499}, 
        {-0.307048, -0.923395, -0.362905, 0.194527, -0.438387},
        {-0.671133, 0.728081, -0.520196, 0.0108215, -0.139992}, 
        {-0.600645, 0.151967, 0.0101909, -0.235608, -0.367466},
        {0.262652, 0.84919, -0.131239, 0.0756875, -0.261777}} 
    };

    float intB[4][5] = {
        -0.0421559, 0.246112, 0.0348797, -0.0619016, 0.0988568,
        4.98184, 4.97131, 4.98673, 4.97446, 4.96925,
        0.255813, 0.527195, 0.120779, -0.0979445, 0.02733,
        0.0091722, 0.551458, -0.0521645, 0.0113755, 0.2287}; 

    float outW[5] = {-0.592906, 0.576557, -0.38704, 0.0146919, -0.35076};

    float outB = -0.0191289;

    float h_state[5] = {0};
    float c_state[5] = {0};
    float i_state[5] = {0};
    float f_state[5] = {0};
    float o_state[5] = {0};
    float g_state[5] = {0};

    short inWF[4][5] = {0};
    short intWF[4][5][5] = {0};
    short intBF[4][5] = {0};
    short outWF[5] = {0};
    short outBF = 0;

    for (i = 0; i < 4; ++i) {
        for (j = 0; j < 5; ++j) {
            inWF[i][j] = (short) (inW[i][j] * SCALER);
            //printf("%d\n", inWF[i][j]);
        }
    }

    for (i = 0; i < 4; ++i) {
        for (j = 0; j < 5; ++j) {
            for (t = 0; t < 5; ++t) {
                intWF[i][j][t] = (short) (intW[i][j][t] * SCALER);
                //printf("%d\n", intWF[i][j][t]);
            }
        }
    }

    for (i = 0; i < 4; ++i) {
        for (j = 0; j < 5; ++j) {
            intBF[i][j] = (short) (intB[i][j] * SCALER);
            //printf("%d\n", intBF[i][j]);
        }
    }

    for (i = 0; i < 5; ++i) {
        outWF[i] = (short) (outW[i] * SCALER);
        //printf("%d\n", outWF[i]);
    }

    outBF = (short) (outB * SCALER);
    //printf("%d\n", outBF);

    short h_stateF[5] = {0};
    short c_stateF[5] = {0};
    short i_stateF[5] = {0};
    short f_stateF[5] = {0};
    short o_stateF[5] = {0};
    short g_stateF[5] = {0};

    short sampleinput_16b;

    for (t = 0; t < SAMPLE_TEST_LEN; ++t) {

        sampleinput_16b = (short) (input[t] + 120000) * 256 / 1875;

        for (j = 0; j < 5; ++j) {
            i_stateF[j] = (inWF[0][j] * sampleinput_16b) >> 15;
            for (i = 0; i < 5; ++i)
                i_stateF[j] += ((h_stateF[i] * intWF[0][j][i]) >> 12);
            i_stateF[j] += intBF[0][j];
            i_stateF[j] = i_stateF[j] >> 5;
            if (i_stateF[j] >= LUT_SIZE)
                i_stateF[j] = 4095;
            else if (i_stateF[j] >= 0)
                i_stateF[j] = lut_sigmoid[i_stateF[j]];
            else if (i_stateF[j] > -LUT_SIZE)
                i_stateF[j] = 4096 - lut_sigmoid[-i_stateF[j]];
            else
                i_stateF[j] = 1;
        }

        for (j = 0; j < 5; ++j) {
            f_stateF[j] = (inWF[1][j] * sampleinput_16b) >> 15;
            for (i = 0; i < 5; ++i)
                f_stateF[j] += ((h_stateF[i] * intWF[1][j][i]) >> 12);
            f_stateF[j] += intBF[1][j];
            f_stateF[j] = f_stateF[j] >> 5;
            if (f_stateF[j] >= LUT_SIZE)
                f_stateF[j] = 4095;
            else if (f_stateF[j] >= 0)
                f_stateF[j] = lut_sigmoid[f_stateF[j]];
            else if (f_stateF[j] > -LUT_SIZE)
                f_stateF[j] = 4096 - lut_sigmoid[-f_stateF[j]];
            else
                f_stateF[j] = 1;
        }

        for (j = 0; j < 5; ++j) {
            o_stateF[j] = (inWF[2][j] * sampleinput_16b) >> 15;
            for (i = 0; i < 5; ++i)
                o_stateF[j] += ((h_stateF[i] * intWF[2][j][i]) >> 12);
            o_stateF[j] += intBF[2][j];
            o_stateF[j] = o_stateF[j] >> 5;
            if (o_stateF[j] >= LUT_SIZE)
                o_stateF[j] = 4095;
            else if (o_stateF[j] >= 0)
                o_stateF[j] = lut_sigmoid[o_stateF[j]];
            else if (o_stateF[j] > -LUT_SIZE)
                o_stateF[j] = 4096 - lut_sigmoid[-o_stateF[j]];
            else
                o_stateF[j] = 1;
        }

        for (j = 0; j < 5; ++j) {
            g_stateF[j] = (inWF[3][j] * sampleinput_16b) >> 15;
            for (i = 0; i < 5; ++i)
                g_stateF[j] += ((h_stateF[i] * intWF[3][j][i]) >> 12);
            g_stateF[j] += intBF[3][j];
            g_stateF[j] = g_stateF[j] >> 5;
            if (g_stateF[j] >= LUT_SIZE)
                g_stateF[j] = 4096;
            else if (g_stateF[j] >= 0)
                g_stateF[j] = lut_tanh[g_stateF[j]];
            else if (g_stateF[j] > -LUT_SIZE)
                g_stateF[j] = -lut_tanh[-g_stateF[j]];
            else
                g_stateF[j] = -4096;
        }
        
        for (j = 0; j < 5; ++j) {
            c_stateF[j] = (((c_stateF[j] * f_stateF[j]) >> 8) + ((g_stateF[j] * i_stateF[j]) >> 12)) >> 4;
            h_stateF[j] = c_stateF[j] >> 1;
            if (h_stateF[j] >= LUT_SIZE)
                h_stateF[j] = 4096;
            else if (h_stateF[j] >= 0)
                h_stateF[j] = lut_tanh[h_stateF[j]];
            else if (h_stateF[j] > -LUT_SIZE)
                h_stateF[j] = -lut_tanh[-h_stateF[j]];
            else
                h_stateF[j] = -4096;
            h_stateF[j] = (h_stateF[j] * o_stateF[j]) >> 12;
        }

        output[t] = outBF;
        for (j = 0; j < 5; ++j)
            output[t] += ((h_stateF[j] * outWF[j]) >> 12);
    }

    return;
}

int main() {

    int i;
    FILE *ifp, *ofp;

    struct timeval t1, t2, tr;

    int sampleinput[SAMPLE_TEST_LEN];
    short test_out1[SAMPLE_TEST_LEN];
    short test_out2[SAMPLE_TEST_LEN];

    // Read in sample input from "converted-lstm-in.txt" file
    if (!(ifp = fopen("converted-lstm-in.txt", "r"))) {
        printf("File converted-lstm-in.txt cannot be opened for read.\n");
        return -1;
    }

    for (i = 0; i < SAMPLE_TEST_LEN; ++i) {
        fscanf(ifp, "%d", &sampleinput[i]);
    }
    fclose(ifp);

    // Open output.txt for output data write back.
    if (!(ofp = fopen("output.txt", "w"))) {
        printf("File output.txt cannot be opened for write.\n");
        return -1;
    }

    gettimeofday(&t1, NULL);
    for (i = 0; i < 50000; ++i) {
        lstm_n5_o1(sampleinput, test_out1);
        lstm_n5_o2(sampleinput, test_out2);
    }
    gettimeofday(&t2, NULL);
    timersub(&t1, &t2, &tr);
    printf("Execute time: %.2f sec\n", -tr.tv_sec-(double)tr.tv_usec/1000000.0);

    for (i = 0; i < SAMPLE_TEST_LEN; ++i)
        fprintf(ofp, "%d,%d\n", test_out1[i], test_out2[i]);

    printf("Processing complete.\n");
    return 0;
}

