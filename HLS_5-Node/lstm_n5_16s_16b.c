#include "ap_cint.h"

#define SHARE_CH_NUM 16
#define SCALER 4096
#define LUT_SIZE 1024

void lstm_n5_16s_16b(
	uint4 ch_ena,
	int24 sampleinput,
	int32 weight[256],
    volatile int16 *lstm_out
    )
{
	static int16 lut_sigmoid[LUT_SIZE] = {
			2048,2056,2064,2072,2080,2088,2096,2104,
			2112,2120,2128,2136,2144,2152,2160,2168,
			2176,2184,2192,2200,2208,2216,2224,2232,
			2239,2247,2255,2263,2271,2279,2287,2295,
			2303,2311,2318,2326,2334,2342,2350,2358,
			2365,2373,2381,2389,2397,2404,2412,2420,
			2428,2435,2443,2451,2458,2466,2474,2481,
			2489,2497,2504,2512,2519,2527,2535,2542,
			2550,2557,2565,2572,2580,2587,2594,2602,
			2609,2617,2624,2631,2639,2646,2653,2661,
			2668,2675,2682,2690,2697,2704,2711,2718,
			2726,2733,2740,2747,2754,2761,2768,2775,
			2782,2789,2796,2803,2810,2817,2823,2830,
			2837,2844,2851,2857,2864,2871,2878,2884,
			2891,2898,2904,2911,2917,2924,2930,2937,
			2943,2950,2956,2963,2969,2975,2982,2988,
			2994,3001,3007,3013,3019,3026,3032,3038,
			3044,3050,3056,3062,3068,3074,3080,3086,
			3092,3098,3104,3110,3116,3121,3127,3133,
			3139,3144,3150,3156,3161,3167,3173,3178,
			3184,3189,3195,3200,3206,3211,3217,3222,
			3227,3233,3238,3243,3249,3254,3259,3264,
			3269,3275,3280,3285,3290,3295,3300,3305,
			3310,3315,3320,3325,3330,3334,3339,3344,
			3349,3354,3358,3363,3368,3372,3377,3382,
			3386,3391,3395,3400,3404,3409,3413,3418,
			3422,3427,3431,3435,3440,3444,3448,3452,
			3457,3461,3465,3469,3473,3477,3481,3486,
			3490,3494,3498,3502,3506,3510,3513,3517,
			3521,3525,3529,3533,3536,3540,3544,3548,
			3551,3555,3559,3562,3566,3570,3573,3577,
			3580,3584,3587,3591,3594,3598,3601,3604,
			3608,3611,3614,3618,3621,3624,3628,3631,
			3634,3637,3640,3644,3647,3650,3653,3656,
			3659,3662,3665,3668,3671,3674,3677,3680,
			3683,3686,3689,3691,3694,3697,3700,3703,
			3705,3708,3711,3714,3716,3719,3722,3724,
			3727,3730,3732,3735,3737,3740,3742,3745,
			3747,3750,3752,3755,3757,3760,3762,3764,
			3767,3769,3772,3774,3776,3778,3781,3783,
			3785,3788,3790,3792,3794,3796,3798,3801,
			3803,3805,3807,3809,3811,3813,3815,3817,
			3819,3821,3823,3825,3827,3829,3831,3833,
			3835,3837,3839,3841,3843,3844,3846,3848,
			3850,3852,3853,3855,3857,3859,3861,3862,
			3864,3866,3867,3869,3871,3872,3874,3876,
			3877,3879,3880,3882,3884,3885,3887,3888,
			3890,3891,3893,3894,3896,3897,3899,3900,
			3902,3903,3905,3906,3907,3909,3910,3912,
			3913,3914,3916,3917,3918,3920,3921,3922,
			3924,3925,3926,3927,3929,3930,3931,3932,
			3934,3935,3936,3937,3938,3940,3941,3942,
			3943,3944,3945,3947,3948,3949,3950,3951,
			3952,3953,3954,3955,3956,3957,3958,3959,
			3960,3961,3963,3964,3965,3966,3966,3967,
			3968,3969,3970,3971,3972,3973,3974,3975,
			3976,3977,3978,3979,3980,3980,3981,3982,
			3983,3984,3985,3986,3986,3987,3988,3989,
			3990,3990,3991,3992,3993,3994,3994,3995,
			3996,3997,3997,3998,3999,4000,4000,4001,
			4002,4003,4003,4004,4005,4005,4006,4007,
			4007,4008,4009,4009,4010,4011,4011,4012,
			4013,4013,4014,4015,4015,4016,4016,4017,
			4018,4018,4019,4019,4020,4021,4021,4022,
			4022,4023,4023,4024,4025,4025,4026,4026,
			4027,4027,4028,4028,4029,4029,4030,4030,
			4031,4031,4032,4032,4033,4033,4034,4034,
			4035,4035,4036,4036,4037,4037,4038,4038,
			4038,4039,4039,4040,4040,4041,4041,4041,
			4042,4042,4043,4043,4043,4044,4044,4045,
			4045,4045,4046,4046,4047,4047,4047,4048,
			4048,4048,4049,4049,4050,4050,4050,4051,
			4051,4051,4052,4052,4052,4053,4053,4053,
			4054,4054,4054,4055,4055,4055,4056,4056,
			4056,4057,4057,4057,4057,4058,4058,4058,
			4059,4059,4059,4059,4060,4060,4060,4061,
			4061,4061,4061,4062,4062,4062,4062,4063,
			4063,4063,4063,4064,4064,4064,4064,4065,
			4065,4065,4065,4066,4066,4066,4066,4067,
			4067,4067,4067,4068,4068,4068,4068,4068,
			4069,4069,4069,4069,4069,4070,4070,4070,
			4070,4070,4071,4071,4071,4071,4071,4072,
			4072,4072,4072,4072,4073,4073,4073,4073,
			4073,4073,4074,4074,4074,4074,4074,4074,
			4075,4075,4075,4075,4075,4075,4076,4076,
			4076,4076,4076,4076,4077,4077,4077,4077,
			4077,4077,4077,4078,4078,4078,4078,4078,
			4078,4078,4079,4079,4079,4079,4079,4079,
			4079,4079,4080,4080,4080,4080,4080,4080,
			4080,4080,4081,4081,4081,4081,4081,4081,
			4081,4081,4082,4082,4082,4082,4082,4082,
			4082,4082,4082,4082,4083,4083,4083,4083,
			4083,4083,4083,4083,4083,4084,4084,4084,
			4084,4084,4084,4084,4084,4084,4084,4084,
			4085,4085,4085,4085,4085,4085,4085,4085,
			4085,4085,4085,4085,4086,4086,4086,4086,
			4086,4086,4086,4086,4086,4086,4086,4086,
			4086,4087,4087,4087,4087,4087,4087,4087,
			4087,4087,4087,4087,4087,4087,4087,4088,
			4088,4088,4088,4088,4088,4088,4088,4088,
			4088,4088,4088,4088,4088,4088,4088,4089,
			4089,4089,4089,4089,4089,4089,4089,4089,
			4089,4089,4089,4089,4089,4089,4089,4089,
			4089,4090,4090,4090,4090,4090,4090,4090,
			4090,4090,4090,4090,4090,4090,4090,4090,
			4090,4090,4090,4090,4090,4090,4090,4091,
			4091,4091,4091,4091,4091,4091,4091,4091,
			4091,4091,4091,4091,4091,4091,4091,4091,
			4091,4091,4091,4091,4091,4091,4091,4091,
			4091,4092,4092,4092,4092,4092,4092,4092,
			4092,4092,4092,4092,4092,4092,4092,4092,
			4092,4092,4092,4092,4092,4092,4092,4092,
			4092,4092,4092,4092,4092,4092,4092,4092,
			4092,4093,4093,4093,4093,4093,4093,4093,
			4093,4093,4093,4093,4093,4093,4093,4093,
			4093,4093,4093,4093,4093,4093,4093,4093,
			4093,4093,4093,4093,4093,4093,4093,4093,
			4093,4093,4093,4093,4093,4093,4093,4093,
			4093,4093,4093,4093,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4095,4095};

	static int16 lut_tanh[LUT_SIZE] = {
			0,32,64,96,128,160,192,224,
			256,288,319,351,383,415,446,478,
			509,541,572,604,635,666,697,728,
			759,790,821,851,882,912,943,973,
			1003,1033,1063,1093,1123,1152,1181,1211,
			1240,1269,1298,1326,1355,1383,1412,1440,
			1468,1496,1523,1551,1578,1605,1632,1659,
			1686,1712,1739,1765,1791,1817,1842,1868,
			1893,1918,1943,1968,1992,2016,2041,2064,
			2088,2112,2135,2158,2181,2204,2227,2249,
			2272,2294,2316,2337,2359,2380,2401,2422,
			2443,2463,2484,2504,2524,2543,2563,2582,
			2602,2621,2639,2658,2676,2695,2713,2731,
			2748,2766,2783,2800,2817,2834,2851,2867,
			2883,2899,2915,2931,2946,2962,2977,2992,
			3007,3021,3036,3050,3064,3078,3092,3106,
			3119,3133,3146,3159,3172,3185,3197,3210,
			3222,3234,3246,3258,3270,3281,3293,3304,
			3315,3326,3337,3347,3358,3368,3379,3389,
			3399,3409,3419,3428,3438,3447,3456,3466,
			3475,3483,3492,3501,3510,3518,3526,3535,
			3543,3551,3559,3566,3574,3582,3589,3596,
			3604,3611,3618,3625,3632,3639,3645,3652,
			3659,3665,3671,3678,3684,3690,3696,3702,
			3707,3713,3719,3724,3730,3735,3741,3746,
			3751,3756,3761,3766,3771,3776,3781,3786,
			3790,3795,3799,3804,3808,3812,3817,3821,
			3825,3829,3833,3837,3841,3845,3848,3852,
			3856,3859,3863,3867,3870,3873,3877,3880,
			3883,3887,3890,3893,3896,3899,3902,3905,
			3908,3911,3913,3916,3919,3922,3924,3927,
			3929,3932,3934,3937,3939,3942,3944,3946,
			3949,3951,3953,3955,3957,3960,3962,3964,
			3966,3968,3970,3972,3973,3975,3977,3979,
			3981,3983,3984,3986,3988,3989,3991,3993,
			3994,3996,3997,3999,4000,4002,4003,4005,
			4006,4007,4009,4010,4011,4013,4014,4015,
			4016,4018,4019,4020,4021,4022,4024,4025,
			4026,4027,4028,4029,4030,4031,4032,4033,
			4034,4035,4036,4037,4038,4039,4039,4040,
			4041,4042,4043,4044,4044,4045,4046,4047,
			4048,4048,4049,4050,4050,4051,4052,4053,
			4053,4054,4055,4055,4056,4056,4057,4058,
			4058,4059,4059,4060,4061,4061,4062,4062,
			4063,4063,4064,4064,4065,4065,4066,4066,
			4067,4067,4067,4068,4068,4069,4069,4070,
			4070,4070,4071,4071,4072,4072,4072,4073,
			4073,4073,4074,4074,4074,4075,4075,4075,
			4076,4076,4076,4077,4077,4077,4078,4078,
			4078,4078,4079,4079,4079,4079,4080,4080,
			4080,4080,4081,4081,4081,4081,4082,4082,
			4082,4082,4082,4083,4083,4083,4083,4084,
			4084,4084,4084,4084,4084,4085,4085,4085,
			4085,4085,4085,4086,4086,4086,4086,4086,
			4086,4087,4087,4087,4087,4087,4087,4087,
			4088,4088,4088,4088,4088,4088,4088,4088,
			4089,4089,4089,4089,4089,4089,4089,4089,
			4089,4090,4090,4090,4090,4090,4090,4090,
			4090,4090,4090,4090,4091,4091,4091,4091,
			4091,4091,4091,4091,4091,4091,4091,4091,
			4091,4092,4092,4092,4092,4092,4092,4092,
			4092,4092,4092,4092,4092,4092,4092,4092,
			4092,4093,4093,4093,4093,4093,4093,4093,
			4093,4093,4093,4093,4093,4093,4093,4093,
			4093,4093,4093,4093,4093,4093,4093,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4094,
			4094,4094,4094,4094,4094,4094,4094,4095,
			4095,4095,4095,4095,4095,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4095,4095,
			4095,4095,4095,4095,4095,4095,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096,
			4096,4096,4096,4096,4096,4096,4096,4096};

#pragma HLS INTERFACE bram port=weight
#pragma HLS RESOURCE variable=weight core=RAM_1P_BRAM

    static int16 h_state[SHARE_CH_NUM][5] = {0};
    static int16 c_state[SHARE_CH_NUM][5] = {0};
    int16 i_state[5] = {0};
    int16 f_state[5] = {0};
    int16 o_state[5] = {0};
    int16 g_state[5] = {0};
#pragma HLS reset variable=h_state
#pragma HLS reset variable=c_state

    int16 lstm_output;
    int i, j;

    int16 sampleinput_16b;
    //sampleinput_16b = (int16) ((sampleinput + 120000) * 256 / 1875);  // 32768 / 240000
    sampleinput_16b = (int16) ((sampleinput + 120000) >> 3);

    for (j = 0; j < 5; ++j) {
#pragma HLS pipeline
    	i_state[j] = ((int16)weight[j] * sampleinput_16b) >> 15;      // inW[0][j]
    	f_state[j] = ((int16)weight[5+j] * sampleinput_16b) >> 15;    // inW[1][j]
    	o_state[j] = ((int16)weight[10+j] * sampleinput_16b) >> 15;   // inW[2][j]
    	g_state[j] = ((int16)weight[15+j] * sampleinput_16b) >> 15;   // inW[3][j]
    }

    for (j = 0; j < 5; ++j) {
    	for (i = 0; i < 5; ++i) {
#pragma HLS pipeline
    		i_state[j] += ((h_state[ch_ena][i] * (int16)weight[20+j*5+i]) >> 12);  // intW[0][j][i]
    		f_state[j] += ((h_state[ch_ena][i] * (int16)weight[45+j*5+i]) >> 12);  // intW[1][j][i]
    		o_state[j] += ((h_state[ch_ena][i] * (int16)weight[70+j*5+i]) >> 12);  // intW[2][j][i]
    		g_state[j] += ((h_state[ch_ena][i] * (int16)weight[95+j*5+i]) >> 12);  // intW[3][j][i]
    	}
    }

    for (j = 0; j < 5; ++j) {
#pragma HLS pipeline
        i_state[j] += (int16)weight[120+j];                                        // intB[0][j]
        i_state[j] = i_state[j] >> 5;
        if (i_state[j] >= LUT_SIZE)
        	i_state[j] = 4095;
        else if (i_state[j] >= 0)
            i_state[j] = lut_sigmoid[i_state[j]];
        else if (i_state[j] > -LUT_SIZE)
            i_state[j] = 4096 - lut_sigmoid[-i_state[j]];
        else
        	i_state[j] = 1;

        f_state[j] += (int16)weight[125+j];                                        // intB[1][j]
        f_state[j] = f_state[j] >> 5;
        if (f_state[j] >= LUT_SIZE)
        	f_state[j] = 4095;
        else if (f_state[j] >= 0)
            f_state[j] = lut_sigmoid[f_state[j]];
        else if (f_state[j] > -LUT_SIZE)
            f_state[j] = 4096 - lut_sigmoid[-f_state[j]];
        else
        	f_state[j] = 1;

        o_state[j] += (int16)weight[130+j];                                        // intB[2][j]
        o_state[j] = o_state[j] >> 5;
        if (o_state[j] >= LUT_SIZE)
        	o_state[j] = 4095;
        else if (o_state[j] >= 0)
            o_state[j] = lut_sigmoid[o_state[j]];
        else if (o_state[j] > -LUT_SIZE)
            o_state[j] = 4096 - lut_sigmoid[-o_state[j]];
        else
        	o_state[j] = 1;

        g_state[j] += (int16)weight[135+j];                                        // intB[3][j]
        g_state[j] = g_state[j] >> 5;
        if (g_state[j] >= LUT_SIZE)
        	g_state[j] = 4096;
        else if (g_state[j] >= 0)
            g_state[j] = lut_tanh[g_state[j]];
        else if (g_state[j] > -LUT_SIZE)
            g_state[j] = -lut_tanh[-g_state[j]];
        else
        	g_state[j] = -4096;
    }

    for (j = 0; j < 5; ++j) {
#pragma HLS pipeline
        c_state[ch_ena][j] = (((c_state[ch_ena][j] * f_state[j]) >> 8) + ((g_state[j] * i_state[j]) >> 12)) >> 4;
        h_state[ch_ena][j] = c_state[ch_ena][j] >> 1;
        if (h_state[ch_ena][j] >= LUT_SIZE)
        	h_state[ch_ena][j] = 4096;
        else if (h_state[ch_ena][j] >= 0)
        	h_state[ch_ena][j] = lut_tanh[h_state[ch_ena][j]];
        else if (h_state[ch_ena][j] > -LUT_SIZE)
        	h_state[ch_ena][j] = -lut_tanh[-h_state[ch_ena][j]];
        else
        	h_state[ch_ena][j] = -4096;
        h_state[ch_ena][j] = (h_state[ch_ena][j] * o_state[j]) >> 12;
    }

    lstm_output = (int16)weight[145];                                              // outB
    for (j = 0; j < 5; ++j)
#pragma HLS pipeline
    	lstm_output += ((h_state[ch_ena][j] * (int16)weight[140+j]) >> 12);        // outW[j]

    *lstm_out = lstm_output;
    return;
}

